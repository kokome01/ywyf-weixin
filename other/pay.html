<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>确认订单</title>
		<meta name="viewport" content="width=device-width" />
		<meta name="viewport" content="initial-scale=1.0,user-scalable=no" />
		<script src="../js/jquery-1.8.3.min.js"></script>
		<script src="../js/pay.js"></script>
		<link rel="stylesheet" type="text/css" href="../css/pay.css" />
		<script type="text/javascript">
			$(document).ready(function() {
				var sku = localStorage.drug
				
				var skus = sku.split(",")
				console.log('ids=' + skus)
				//ajax
				$.ajax({
					url: 'http://192.168.0.103/ywyf-weixin/cart/toVerfiyPro', //地址
					dataType: "json",
					type: "post",
					xhrFields: {
						withCredentials: true
					},
					timeout: 50000,
					data: 'ids=' + skus,
					success: function(data) {
						console.log(JSON.stringify(data));
						if(data.status != 0) {
							//地址
							var address = false;
							for(i = 0; i < data.mailLists.length; i++) {
								if(data.mailLists[i].isDefault) {
									address = true;
									$("#address_t_name").text(data.mailLists[i].name);
									$("#address_t_tel").text(data.mailLists[i].tel);
									$("#address_t_address").text(data.mailLists[i].address);
									$(".address").attr("tid", data.mailLists[i].id)
								}
							}
							if(address == false) {
								$("#address_t_name").text(data.mailLists[0].name);
								$("#address_t_tel").text(data.mailLists[0].tel);
								$("#address_t_address").text(data.mailLists[0].address);
								$(".address").attr("tid", data.mailLists[0].id);
							}
							//商品
							var strhtmlo = ""
							var strhtmli = ""
							var c = ""
							for(i = 0; i < data.proShops.length; i++) {
								for(j = 0; j < data.proShops[i].buyerItems.length; j++) {
									//判断是否存货足以
									if(data.proShops[i].buyerItems[j].sku.stock <= 0) {
										c = "暂无存货"
									}else if(data.proShops[i].buyerItems[j].sku.stock-data.proShops[i].buyerItems[j].amount<=0){
										c = "存货不足购买"
									}else {
										c = ""
									}
									strhtmli += '<li class="pay_list_b" kid="'
										+data.proShops[i].buyerItems[j].sku.id+
										'"><img src="' +
										data.proShops[i].buyerItems[j].product.pic +
										'" /><div class="pay_list_b_t"><p>' +
										data.proShops[i].buyerItems[j].product.name +
										'</p><p>规格：<span>' +
										data.proShops[i].buyerItems[j].sku.spec +
										'</span></p><p><span>￥</span><span class="pay_price">'
										+data.proShops[i].buyerItems[j].sku.price+
										'</span><label class="quantity">' +
										data.proShops[i].buyerItems[j].amount +
										'</label><label>×</label><label class="non_stock">' +
										c +
										'</label></p></div></li>'
								}
								strhtmlo += '<li class="pay_list"><div class="pay_list_h"><span>' +
									data.proShops[i].phName +
									'</span></div><ul>' +
									strhtmli +
									'</ul><div class="pay_list_f"><p>共<span>2</span>类商品，共小计：<span class="cc0000 small_plan">0.00</span></p><p>运费：<span class="cc0000 express_sm">' +
									(data.proShops[i].mailFee).toFixed(2) +
									'</span></p></div></li>'
							}
							$(".pay_box ul").empty().append(strhtmlo);
							/*页面计算*/
							//暂无存货
							non_stock()
							//产家小计
							subtotal()
							//产品金额
							grand_total()
							//实际付款
							payment()

						} else {
							alert("请登录");
							window.location.href = 'login.html'
						}

					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						//alert(XMLHttpRequest.status);
						//alert(XMLHttpRequest.readyState);
						//alert(textStatus);
						console.log("网络请求失败，请联系网站管理员!");
					},
				})
			})

			function pay_successl(){
				var kid = new Array();
				for(i=0;i<$(".pay_list_b").length;i++){
					kid.push($(".pay_list_b").eq(i).attr("kid"))
				}
				console.log(kid)
				//ajax
				$.ajax({
					url: 'http://192.168.0.103/ywyf-weixin/cart/catrToOrder', //地址
					dataType: "json",
					type: "post",
					xhrFields: {
						withCredentials: true
					},
					timeout: 50000,
					data: 'sendId='+$(".address").attr("tid")+'&ids='+kid,
					success: function(data) {
						if(data.omsg=="库存不足!"){
							alert("库存不足!")
						}else if(data.omsg=="请登录"){
							alert("请登录");
							window.location.href = 'login.html'
						}else{
							alert("交易成功")
						}
						console.log(JSON.stringify(data));
						//成功
					},
					error: function(XMLHttpRequest, textStatus, errorThrown) {
						//alert(XMLHttpRequest.status);
						//alert(XMLHttpRequest.readyState);
						//alert(textStatus);
						console.log("网络请求失败，请联系网站管理员!");
					},
				})
			}
		</script>
	</head>

	<body>
		<!--头部-->
		<div class="head">
			<div class="head_l">
				<a href="javascript:history.back(-1);" class="back"><img src="../img/left.png" /></a>
				<div>
					<span class="login_head">确认订单</span>
				</div>
			</div>
		</div>
		<!--支付-->
		<div class="body">
			<div class="address" onclick="window.location.href='adddress.html'">
				<div class="address_comm address_flex">
					<img src="../img/address.png">
				</div>
				<p><span class="address_t" id="address_t_name">陈思思</span><span class="address_t" id="address_t_tel">15967125243</span></p>
				<p class="address_add"><span id="address_t_address">浙江省杭州市萧山区家乐公寓456464456456</span></p>
				<div class="address_href address_flex"><img src="../img/right (1).png" /></div>
				<img src="../img/address_bor.jpg" class="address_bor" />
			</div>
			<div class="pay_box">
				<ul>
					<li class="pay_list">
						<div class="pay_list_h">
							<span>湖南一格</span>
						</div>
						<ul>

						</ul>
						<div class="pay_list_f">
							<p>共<span>2</span>类商品，共小计：<span class="cc0000 small_plan">0.00</span></p>
							<p>运费：<span class="cc0000 express_sm">3.00</span></p>
						</div>
					</li>
					<li class="pay_list">
						<div class="pay_list_h">
							<span>湖南一格</span>
						</div>
						<ul>
							<li class="pay_list_b">
								<img src="../img/2017.jpg" />
								<div class="pay_list_b_t">
									<p>钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片</p>
									<p>规格：<span>256g</span></p>
									<p><span>￥</span><span class="pay_price">26.44</span><label class="quantity">1</label><label>×</label><label class="non_stock">暂无存货</label></p>
								</div>
							</li>
							<li class="pay_list_b">
								<img src="../img/2017.jpg" />
								<div class="pay_list_b_t">
									<p>钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片</p>
									<p>规格：<span>256g</span></p>
									<p><span>￥</span><span class="pay_price">26.44</span><label class="quantity">1</label><label>×</label><label class="non_stock"></label></p>
								</div>
							</li>
							<li class="pay_list_b">
								<img src="../img/2017.jpg" />
								<div class="pay_list_b_t">
									<p>钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片钙尔奇跑碳酸钙主角片</p>
									<p>规格：<span>256g</span></p>
									<p><span>￥</span><span class="pay_price">26.44</span><label class="quantity">2</label><label>×</label><label class="non_stock"></label></p>
								</div>
							</li>
						</ul>
						<div class="pay_list_f">
							<p>共<span>2</span>类商品，共小计：<span class="cc0000 small_plan">0.00</span></p>
							<p>运费：<span class="cc0000 express_sm">3.00</span></p>
						</div>
					</li>
				</ul>
			</div>
			<div class="payment">
				<span>支付配送</span>
				<div class="payment_right">
					<p>在线支付</p>
					<p>快递运输</p>
					<p>工作日，双休与节假日均可送货</p>
				</div>
			</div>
			<div class="pay_money">
				<p><span>商品金额</span ><span class="cc0000 grand_total">00.00</span><span class="cc0000">￥</span>
				</p>
				<p><span>运费</span><span class="cc0000 express_big">0.00</span><span class="cc0000">￥</span>
				</p>
			</div>
		</div>
		<div class="foot">
			<div class="foot_money">
				<p>实际付款：￥<span class="payment_num">00.00</span></p>
			</div>
			<div class="foot_but" onclick="pay_successl()">提交订单</div>
		</div>
	</body>

</html>